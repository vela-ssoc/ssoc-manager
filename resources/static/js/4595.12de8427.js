"use strict";(self["webpackChunkssoc"]=self["webpackChunkssoc"]||[]).push([[4595],{74804:function(e,t,s){s.d(t,{A:function(){return u}});var a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"icon-body"},[t("el-input",{staticStyle:{position:"relative"},attrs:{clearable:"",placeholder:"请输入图标名称"},on:{clear:e.filterIcons},nativeOn:{input:function(t){return e.filterIcons.apply(null,arguments)}},model:{value:e.name,callback:function(t){e.name=t},expression:"name"}},[t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"suffix"},slot:"suffix"})]),t("div",{staticClass:"icon-list"},e._l(e.iconList,(function(s,a){return t("div",{key:a,on:{click:function(t){return e.selectedIcon(s)}}},[t("svg-icon",{staticStyle:{height:"40px",width:"26px"},attrs:{"icon-class":s}})],1)})),0)],1)},i=[];const o=s(72922),r=e=>e.keys(),n=/\.\/(.*)\.svg/,l=r(o).map((e=>e.match(n)[1]));var c=l,h={name:"IconSelect",data(){return{name:"",iconList:c}},methods:{filterIcons(){this.name?this.iconList=this.iconList.filter((e=>e.includes(this.name))):this.iconList=c},selectedIcon(e){this.$emit("selected",e),document.body.click()},reset(){this.name="",this.iconList=c}}},d=h,p=s(81656),m=(0,p.A)(d,a,i,!1,null,"4634c9b8",null),u=m.exports},84595:function(e,t,s){s.r(t),s.d(t,{default:function(){return ve}});var a=function(){var e=this,t=e._self._c;return t("div",[t("el-card",{staticClass:"contentCard_",staticStyle:{position:"relative"}},[e.tabs.length?[t("el-tabs",{attrs:{"before-leave":e.beforeTabLeave},model:{value:e.activeName,callback:function(t){e.activeName=t},expression:"activeName"}},[e._l(e.tabs,(function(s,a){return t("el-tab-pane",{key:a,staticClass:"test",attrs:{name:s.value}},[t("span",{staticClass:"tabHeader",attrs:{slot:"label"},slot:"label"},[t("svg-icon",{staticClass:"el-input__icon",staticStyle:{height:"16px",width:"16px"},attrs:{"icon-class":s.icon}}),e._v(" "+e._s(s.label)+" "),s.id?t("i",{staticClass:"el-icon-error",on:{click:function(t){return t.stopPropagation(),e.deleteTag(s.id)}}}):e._e()],1)])})),t("el-tab-pane",{attrs:{name:"add"}},[t("span",{attrs:{slot:"label"},slot:"label"},[t("el-link",{attrs:{type:"primary"},on:{click:e.addNew}},[t("i",{staticClass:"el-icon-plus"}),e._v("添加新类型")])],1)])],2),t("platform",{key:e.activeName,attrs:{goosOptions:e.goosOptions||[],"agent-type":e.activeName},on:{refresTab:e.loadTabs}})]:t("el-empty",{attrs:{description:"无数据"}},[t("el-button",{attrs:{type:"primary"},on:{click:e.addNew}},[e._v("上传安装包")])],1)],2),t("addNewTab",{ref:"addNewTabRef"})],1)},i=[],o=function(){var e=this,t=e._self._c;return t("div",{staticStyle:{display:"flex","min-height":"calc(100vh - 154px)"}},[t("div",[t("el-menu",{ref:"menuRef",staticClass:"platfrom",attrs:{"default-active":e.sysActive,router:!1},on:{select:e.select}},[e._l(e.sysTypes,(function(s,a){return t("el-menu-item",{key:a,attrs:{index:s.id}},["linux"===s.goos?t("i",{staticClass:"fa fa-linux"}):"windows"===s.goos?t("i",{staticClass:"fa fa-windows"}):t("i",{staticClass:"el-icon-menu"}),t("span",{attrs:{slot:"title"},slot:"title"},[e._v(" "+e._s(s.goos)+" - "+e._s(s.arch)+" ")])])})),t("el-menu-item",{attrs:{index:"add"},on:{click:e.addNew}},[t("span",{attrs:{slot:"title"},slot:"title"},[t("el-button",{attrs:{type:"text"}},[e._v("+添加系统")])],1)])],2)],1),t("div",{staticStyle:{flex:"1","padding-left":"10px"}},[t("agent",{key:e.sysActiveCache,attrs:{"agent-type":e.agentType,goos:e.goos,arch:e.arch},on:{refreshGoos:function(t){return e.$emit("refresTab")}}})],1),t("addNewAgent",{ref:"addNewAgentRef"})],1)},r=[],n=function(){var e=this,t=e._self._c;return t("div",{staticStyle:{height:"100%"}},[e.activeVersionData?t("el-row",{staticStyle:{"min-height":"100%"},attrs:{type:"flex"}},[t("el-col",{attrs:{span:17}},[t("el-row",[t("el-col",{attrs:{span:4}},[t("div",{staticStyle:{display:"flex","flex-direction":"column","align-items":"center"}},[t("svg-icon",{staticStyle:{height:"100px","margin-bottom":"10px",width:"100px"},attrs:{"icon-class":e.goosIcon}})],1)]),t("el-col",{staticStyle:{"padding-left":"10px"},attrs:{span:20}},[t("div",{},[t("b",{},[t("editAndSavaBtn",{attrs:{value:e.activeVersionData.tipsEdit},on:{edit:function(t){e.activeVersionData.tipsEdit=!0},save:e.saveTips}})],1)]),e.activeVersionData.tipsEdit?t("el-input",{staticStyle:{width:"100%","margin-top":"10px"},attrs:{type:"textarea",rows:6,resize:"none",placeholder:"无"},model:{value:e.activeVersionData.caution,callback:function(t){e.$set(e.activeVersionData,"caution",t)},expression:"activeVersionData.caution"}}):t("pre",{staticStyle:{"min-height":"80px"}},[e._v(e._s(e.activeVersionData.caution))])],1)],1),t("el-row",{staticStyle:{"margin-top":"40px"}},[t("el-col",{attrs:{span:4}},[t("div",{staticStyle:{display:"flex","flex-direction":"column","align-items":"flex-end"}},[t("el-menu",{ref:"menuRef",attrs:{"default-active":e.defaultActive,router:!1},on:{select:e.select}},[t("el-menu-item",{attrs:{index:"opt"},on:{click:e.addNewAgent}},[t("el-button",{staticStyle:{transform:"translateY(-2px)"},attrs:{size:"mini",type:"text"}},[e._v(" +新版本")])],1),e._l(e.versionData,(function(s,a){return t("el-menu-item",{key:a,attrs:{index:s.id}},[e._v(" "+e._s(s.semver)),s.deprecated?t("el-tag",{staticStyle:{"margin-left":"5px"},attrs:{type:"info",size:"mini",round:""}},[e._v("已过期")]):e._e(),s.unstable?t("el-tag",{staticStyle:{"margin-left":"5px"},attrs:{type:"info",size:"mini",round:""}},[e._v("测试")]):e._e()],1)}))],2)],1)]),t("el-col",{staticStyle:{"padding-left":"10px"},attrs:{span:20}},[t("div",{staticStyle:{"font-size":"12px",display:"flex","align-items":"center","justify-content":"space-between"}},[t("span",{staticStyle:{display:"flex","list-style":"none"}},[t("el-tag",{attrs:{size:"mini"}},[e._v(e._s(e.activeVersionData.name))]),t("el-tag",{attrs:{size:"mini"}},[e._v(e._s(e.activeVersionData.arch))]),t("el-tag",{attrs:{size:"mini"}},[e._v(e._s(e.activeVersionData.ctimeFormat))])],1),t("div",[t("el-button",{staticClass:"mr-2",attrs:{type:"primary",disabled:e.activeVersionData.deprecated,size:"mini"},on:{click:()=>e.$refs.installGuideRef.openDialog(e.activeVersionData)}},[t("i",{staticClass:"el-icon-tickets"}),e._v(" agent安装指引")]),t("el-dropdown",{on:{command:e.handleCommand}},[t("span",{staticClass:"el-dropdown-link"},[t("i",{staticClass:"el-icon-setting"}),e._v(" 选项"),t("i",{staticClass:"el-icon-arrow-down el-icon--right"})]),t("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[t("el-dropdown-item",{attrs:{command:"download"}},[t("i",{staticClass:"el-icon-download"}),e._v("下载原始二进制包")]),t("el-dropdown-item",{attrs:{command:"deprecate"}},[t("i",{staticClass:"el-icon-s-release"}),t("span",[e._v("标记过期")])]),t("el-dropdown-item",{attrs:{command:"push"}},[t("i",{staticClass:"el-icon-upload2"}),t("span",[t("span",{staticClass:"text-blue-500"},[e._v("推送更新")])])]),t("el-dropdown-item",{attrs:{command:"delete"}},[t("span",[t("i",{staticClass:"el-icon-delete"}),t("span",{staticClass:"text-red-500"},[e._v("删除")])])])],1)],1)],1)]),t("div",{staticStyle:{"margin-top":"30px"}},[t("editAndSavaBtn",{attrs:{value:e.activeVersionData.changelogEdit},on:{edit:function(t){e.activeVersionData.changelogEdit=!0},save:e.saveChangelog}}),t("transition",{attrs:{mode:"out-in"}},[e.activeVersionData.changelogEdit?t("el-input",{staticStyle:{width:"100%","margin-top":"10px"},attrs:{type:"textarea",rows:6,resize:"none",placeholder:"无"},model:{value:e.activeVersionData.changelog,callback:function(t){e.$set(e.activeVersionData,"changelog",t)},expression:"activeVersionData.changelog"}}):t("pre",{key:e.activeVersionData.changelog},[e._v(e._s(e.activeVersionData.changelog))])],1)],1)])],1)],1),t("el-col",{staticClass:"desc",staticStyle:{"padding-left":"30px"},attrs:{span:7}},[t("div",{staticStyle:{"line-height":"20px","border-left":"3px solid var(--themeColor)","padding-left":"5px",transform:"translate(-5px, 2px)",display:"flex","align-items":"center","margin-bottom":"10px"}},[t("b",[e._v("功能列表 "),t("editAndSavaBtn",{attrs:{value:e.activeVersionData.featureEdit},on:{edit:function(t){e.activeVersionData.featureEdit=!0},save:e.saveFeture}})],1)]),e.activeVersionData.featureEdit?t("el-input",{staticClass:"featureList",staticStyle:{height:"100%"},attrs:{type:"textarea",resize:"none",readonly:!e.activeVersionData.featureEdit,placeholder:"无"},model:{value:e.activeVersionData.ability,callback:function(t){e.$set(e.activeVersionData,"ability",t)},expression:"activeVersionData.ability"}}):t("el-row",{key:e.activeVersionData.id,staticClass:"featureList",staticStyle:{"flex-wrap":"wrap"},attrs:{type:"flex",gutter:3}},e._l(e.textFormat(e.activeVersionData.ability),(function(s,a){return t("el-col",{key:a,staticStyle:{margin:"1px 0"},attrs:{span:8}},[t("el-tag",{attrs:{type:"info",size:"mini"}},[e._v(e._s(s))])],1)})),1)],1)],1):[t("el-empty",{attrs:{description:"无数据"}})],t("share",{ref:"shareRef"}),t("addNewAgent",{ref:"addNewAgentRef"}),t("installGuide",{ref:"installGuideRef"})],2)},l=[],c=s(72505),h=s.n(c),d=s(95093),p=s.n(d),m=function(){var e=this,t=e._self._c;return t("span",[e.value?t("span",{staticStyle:{color:"var(--themeColor)",cursor:"pointer"},on:{click:e.saveHandler}},[e._v(" 保存 ")]):t("i",{staticClass:"el-icon-edit-outline",staticStyle:{cursor:"pointer",color:"#409eff"},on:{click:e.editHandler}})])},u=[],f={props:{value:Boolean},methods:{saveHandler(){this.$emit("save")},editHandler(){this.$emit("edit")}}},v=f,g=s(81656),y=(0,g.A)(v,m,u,!1,null,"b08bc708",null),b=y.exports,w=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{visible:e.downShow,title:("share"===e.type?"分享":"下载")+"客户端",width:"300px"},on:{"update:visible":function(t){e.downShow=t}}},[t("el-select",{staticStyle:{width:"100%"},attrs:{size:"small","value-key":"id"},on:{change:e.seletRoom},model:{value:e.selectData,callback:function(t){e.selectData=t},expression:"selectData"}},e._l(e.roomData,(function(e){return t("el-option",{key:e.id,attrs:{value:e,label:e.name}})})),1),t("div",{staticStyle:{"margin-top":"20px"}},["share"===e.type?[t("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.lanShare}},[e._v("内网分享 ")]),t("el-button",{directives:[{name:"clipboard",rawName:"v-clipboard:copy",value:e.copyvalue,expression:"copyvalue",arg:"copy"},{name:"clipboard",rawName:"v-clipboard:success",value:e.firstCopySuccess,expression:"firstCopySuccess",arg:"success"}],attrs:{type:"primary",size:"small"},on:{click:e.vipShare}},[e._v("外网分享 ")])]:t("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.downFile}},[e._v("下载")])],2),t("button",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"},{name:"clipboard",rawName:"v-clipboard:copy",value:e.copyvalue,expression:"copyvalue",arg:"copy"},{name:"clipboard",rawName:"v-clipboard:success",value:e.firstCopySuccess,expression:"firstCopySuccess",arg:"success"}],ref:"copyvalueRef",staticStyle:{display:"inline-block"}})],1)},x=[],k={data(){return{downShow:!1,roomData:[],selectData:{},copyvalue:"",value:"",editionId:"",activeData:{},type:"share"}},methods:{firstCopySuccess(){this.$message.success("内容已复制到剪切板！")},openDialog(e,t="share"){this.type=t,this.editionId=e.id,this.activeData=e,this.downShow=!0,this.$request.fetchGetIndices().then((e=>{this.roomData=e.data,this.selectData=this.roomData?.[0]||null}))},downFile(){if(this.selectData.id){let e=document.createElement("a");e.href="/api/v1/deploy/minion/download?id="+this.editionId+"&broker_id="+this.selectData.id,e.target="_blank",e.click()}else this.$message.error("请选择")},lanShare(){this.copyvalue="",this.selectData.id?this.selectData?.lan?.length>0?this.$request.fetchGetLan().then((e=>{const t=e.data.scheme+"://"+e.data.addr+"/api/v1/deploy/minion?"+new URLSearchParams({broker_id:this.selectData.id,goos:this.activeData.goos,arch:this.activeData.arch,version:this.activeData.semver,unstable:this.activeData.unstable,customized:this.activeData.customized});this.copyvalue="windows"!==this.activeData.goos?`curl "${t}" | /bin/bash`:t,this.$nextTick((()=>{this.$refs.copyvalueRef.click()}))})).catch((e=>{console.error(e),this.$message.error("复制地址出错")})):(this.copyvalue="",this.$message.error("暂无内网")):(this.copyvalue="",this.$message.error("请选择"))},vipShare(){if(this.copyvalue="",this.selectData.id){const e=window.location.protocol+"//"+window.location.host+"/api/v1/deploy/minion?"+new URLSearchParams({broker_id:this.selectData.id,goos:this.activeData.goos,arch:this.activeData.arch,version:this.activeData.semver,unstable:this.activeData.unstable,customized:this.activeData.customized});this.copyvalue="windows"!==this.activeData.goos?`curl "${e}" | /bin/bash`:e}else this.$message.error("请选择")},seletRoom(){this.$request.fetchGetLan().then((e=>{this.value=e.data.scheme+"://"+e.data.addr+"/api/v1/deploy/minion?goos="+this.activeData.goos+"&broker_id="+this.selectData.id+"&arch="+this.activeData.arch}))}}},_=k,D=(0,g.A)(_,w,x,!1,null,"b884d93a",null),$=D.exports,S=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{"el-dialog":"",visible:e.fileShow,title:e.form.goos?"新增版本":"新增系统类型并上传新版本","append-to-body":"",width:"500px","destroy-on-close":""},on:{"update:visible":function(t){e.fileShow=t},close:e.onClose}},[t("el-form",{ref:"form",attrs:{model:e.form,rules:e.rules,size:"small","label-width":"100px"}},[t("el-form-item",{attrs:{label:"文件",prop:"file"}},[t("el-upload",{ref:"file",staticClass:"upload-demo",attrs:{action:"/","on-remove":e.handleRemove,"before-remove":e.beforeRemove,"on-change":e.filseSuccess,multiple:"",limit:1,accept:"windows"===e.form.goos?".exe":"","on-exceed":e.handleExceed,"auto-upload":!1}},[t("el-button",{attrs:{size:"small",icon:"el-icon-upload"}},[e._v("点击上传")])],1)],1),t("el-form-item",{attrs:{label:"名称",prop:"name"}},[t("el-input",{attrs:{type:"text",placeholder:"请输入安装包名称",size:"mini"},model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),e.editcustomized?t("el-form-item",{attrs:{label:"发行版本",prop:"customized"}},[t("el-input",{attrs:{type:"text",readonly:!e.editcustomized,placeholder:"请输入发行版本名称，例：标准版",size:"mini"},model:{value:e.form.customized,callback:function(t){e.$set(e.form,"customized",t)},expression:"form.customized"}})],1):e._e(),e.eidtGoos?t("el-form-item",{attrs:{label:"操作系统",prop:"goos"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{disabled:!e.eidtGoos,size:"mini"},on:{change:e.changeGoos},model:{value:e.form.goos,callback:function(t){e.$set(e.form,"goos",t)},expression:"form.goos"}},e._l(e.paltformList,(function(e,s){return t("el-option",{key:s,attrs:{value:e.value,label:e.name}})})),1)],1):e._e(),e.eidtGoos?t("el-form-item",{attrs:{label:"系统架构",prop:"arch"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{disabled:!e.eidtGoos},model:{value:e.form.arch,callback:function(t){e.$set(e.form,"arch",t)},expression:"form.arch"}},e._l(e.archData,(function(e){return t("el-option",{key:e.label,attrs:{value:e.value,label:e.name}})})),1)],1):e._e(),t("el-form-item",{attrs:{label:"版本号",prop:"semver"}},[t("el-input",{attrs:{type:"text",placeholder:"例:1.1.0",size:"mini"},model:{value:e.form.semver,callback:function(t){e.$set(e.form,"semver",t)},expression:"form.semver"}})],1),t("el-form-item",{attrs:{label:"是否测试版",prop:"unstable"}},[t("el-radio-group",{model:{value:e.form.unstable,callback:function(t){e.$set(e.form,"unstable",t)},expression:"form.unstable"}},[t("el-radio",{attrs:{label:!1}},[e._v("否")]),t("el-radio",{attrs:{label:!0}},[e._v("是")])],1)],1),t("el-form-item",{attrs:{label:"功能列表",prop:"ability"}},[t("el-input",{attrs:{type:"textarea",autosize:{minRows:2},placeholder:"请输入内容"},model:{value:e.form.ability,callback:function(t){e.$set(e.form,"ability",t)},expression:"form.ability"}})],1),t("el-form-item",{attrs:{label:"注意事项",prop:"caution"}},[t("el-input",{attrs:{type:"textarea",autosize:{minRows:2},placeholder:"请输入内容"},model:{value:e.form.caution,callback:function(t){e.$set(e.form,"caution",t)},expression:"form.caution"}})],1),t("el-form-item",{attrs:{label:"版本更新日志",prop:"changelog"}},[t("el-input",{attrs:{type:"textarea",autosize:{minRows:2},placeholder:"请输入内容"},model:{value:e.form.changelog,callback:function(t){e.$set(e.form,"changelog",t)},expression:"form.changelog"}})],1)],1),e.showProgress?t("el-progress",{attrs:{percentage:e.percentageformat}}):e._e(),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"small"},on:{click:function(t){e.fileShow=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){return e.onSubmit("form")}}},[e._v("提交")])],1)],1)},C=[],V=s(98362);function z(e,t,s){return(t=I(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function I(e){var t=A(e,"string");return"symbol"==typeof t?t:t+""}function A(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class T{constructor(){z(this,"customized",""),z(this,"name",""),z(this,"goos",""),z(this,"file",""),z(this,"arch",""),z(this,"semver",""),z(this,"changelog",""),z(this,"unstable",!1),z(this,"ability",""),z(this,"caution","")}formatter(){let e=new FormData;return e.append("name",this.name),e.append("semver",this.semver),e.append("goos",this.goos),e.append("arch",this.arch),e.append("changelog",this.changelog),e.append("ability",this.ability),e.append("unstable",this.unstable),e.append("caution",this.caution),e.append("customized","标准版"===this.customized?"":this.customized),e.append("file",this.file),e}}var N={data(){return{form:new T,fileShow:!1,showProgress:!1,percentage:0,paltformList:[],timer:null,eidtGoos:!1,editcustomized:!1,rules:{file:[{required:!0,message:"请上传文件",trigger:"change"}],customized:[{required:!0,message:"请输入发行版本名称",trigger:"change"}],semver:[{required:!0,message:"请输入版本",trigger:"blur"}],name:[{required:!0,message:"请输入文件名",trigger:"blur"}],arch:[{required:!0,message:"请输入系统架构",trigger:"change"}],goos:[{required:!0,message:"请输入操作系统",trigger:"blur"}]},archData:[],res:null,rej:null}},computed:{percentageformat(){return Math.min(100,+Number(this.percentage).toFixed(1))}},created(){this.getSupportArch()},methods:{openDialog(e,t,s){return this.$nextTick((()=>{this.$refs.form?.resetFields()})),this.form=new T,this.form.customized=e,this.form.goos=t,this.form.arch=s,this.fileShow=!0,this.showProgress=!1,this.percentage=0,this.eidtGoos=!t,this.editcustomized=!e,this.form.goos||(this.form.goos=this.paltformList?.[0]?.value),this.changeGoos(),clearInterval(this.timer),new Promise(((e,t)=>{this.res=e,this.rej=t}))},getSupportArch(){V.A.get("/monbin/supports").then((e=>{this.paltformList=e.data||[]}))},changeGoos(){this.archData=this.paltformList.find((e=>e.value===this.form.goos))?.architectures||[],this.form.arch=void 0},filseSuccess(e,t){this.form.file=e.raw,this.form.name=e.name},handleRemove(e,t){this.form.file=""},beforeRemove(e,t){return this.$confirm(`确定移除 ${e.name} ？`)},handleExceed(e,t){this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${e.length} 个文件，共选择了 ${e.length+t.length} 个文件`)},onSubmit(){const e=this.form.formatter();this.showProgress=!0,this.percentage=0,clearInterval(this.timer),this.timer=setInterval((()=>{this.percentage<30?this.percentage+=.3:this.percentage<80?this.percentage+=50/150:this.percentage<90?this.percentage+=.1:this.percentage<98?this.percentage+=.04:this.percentage+=.004,this.percentage>=100&&clearInterval(this.timer)}),100),this.$request.fetchUploadFile(e).then((e=>{this.$message({message:"添加成功!!!",type:"success"}),this.fileShow=!1,this.res()})).catch((e=>{this.$message.error(e.data)})).finally((()=>{this.showProgress=!1}))},onClose(){this.rej?.()}}},R=N,L=(0,g.A)(R,S,C,!1,null,"200d23cc",null),q=L.exports,E=s(72661),P=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{visible:e.dialogShow,width:"650px","destroy-on-close":"","show-close":!1},on:{"update:visible":function(t){e.dialogShow=t}},scopedSlots:e._u([{key:"title",fn:function(){return[t("span",{staticClass:"text-[18px]"},[t("i",{staticClass:"el-icon-tickets text-blue-500"}),e._v(" 部署安装指引")])]},proxy:!0}])},[t("div",{staticClass:"grid grid-cols-[130px_1fr] gap-4 my-2"},[t("div",{staticClass:"bg-gray-100 rounded-sm p-3 space-y-[20px]"},[t("div",[t("p",{staticClass:"text-[14px] text-black"},[e._v("分支版本")]),t("p",{staticClass:"mt-[1px]"},[e._v(e._s(e.agentInfo.customized||"标准版"))])]),t("div",[t("p",{staticClass:"text-[14px] text-black"},[e._v("平台架构")]),t("p",{staticClass:"mt-[1px]"},[e._v(e._s(e.agentInfo.goos)+"-"+e._s(e.agentInfo.arch))])]),t("div",[t("p",{staticClass:"text-[14px] text-black"},[e._v("版本号")]),t("p",{staticClass:"mt-[1px]"},[e._v(e._s(e.agentInfo.semver))])]),t("div",[t("p",{staticClass:"text-[14px] text-black"},[e._v("上传时间")]),t("p",{staticClass:"mt-[1px]"},[e._v(" "+e._s(e.moment(e.agentInfo.ctimeFormat).format("YYYY/MM/DD"))+" ")]),t("p",[e._v(" "+e._s(e.moment(e.agentInfo.ctimeFormat).format("HH:mm:ss"))+" ")])]),t("button",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"},{name:"clipboard",rawName:"v-clipboard:copy",value:e.copyvalue,expression:"copyvalue",arg:"copy"},{name:"clipboard",rawName:"v-clipboard:success",value:e.firstCopySuccess,expression:"firstCopySuccess",arg:"success"}],ref:"copyvalueRef",staticStyle:{display:"inline-block"}})]),t("div",{staticClass:"space-y-[15px] pr-2"},[t("div",{staticClass:"flex justify-between items-center"},[t("span",{staticClass:"text-black"},[e._v("通信节点")]),t("el-select",{staticClass:"w-[310px]",attrs:{size:"mini"},model:{value:e.form.broker,callback:function(t){e.$set(e.form,"broker",t)},expression:"form.broker"}},e._l(e.roomData,(function(e){return t("el-option",{key:e.id,attrs:{value:e.id,label:e.name}})})),1)],1),t("div",{staticClass:"flex justify-between items-center"},[t("span",{staticClass:"text-black"},[e._v("安装包下载方式")]),t("el-radio-group",{staticClass:"w-[310px]",model:{value:e.form.type,callback:function(t){e.$set(e.form,"type",t)},expression:"form.type"}},[t("el-radio",{staticClass:"mr-[10px] w-[150px]",attrs:{label:1}},[e._v("broker代理")]),e.isVip?t("el-radio",{staticClass:"mr-[0px] w-[150px]",attrs:{label:3}},[e._v("broker代理(外网)")]):e._e(),t("el-radio",{staticClass:"mr-[10px] w-[150px]",attrs:{label:2}},[e._v("manager直连(外网)")]),t("el-radio",{staticClass:"mr-[0px] w-[150px]",attrs:{label:4}},[e._v("manager直连(内网)")])],1)],1),t("div",[t("p",{staticClass:"text-black mb-[1px] cursor-pointer",on:{click:function(t){e.form.advanced=!e.form.advanced}}},[e._v(" 高级选项 "),t("span",{staticClass:"el-icon-arrow-down transition",class:{"rotate-180":e.form.advanced}})]),e.form.advanced?[t("p",[t("el-checkbox",{attrs:{label:"忽略当前指定版本，始终安装最新正式版"},model:{value:e.form.keepLastest,callback:function(t){e.$set(e.form,"keepLastest",t)},expression:"form.keepLastest"}})],1),t("div",{staticClass:"mt-[2px]"},[e.form.tags.length>0?t("span",{staticClass:"mr-2"},e._l(e.form.tags,(function(s,a){return t("el-tag",{key:a,staticStyle:{"font-weight":"normal","margin-bottom":"5px"},attrs:{closable:"",size:"mini","disable-transitions":!1},on:{close:function(t){return e.handleClose(s)}}},[e._v(" "+e._s(s)+" ")])})),1):e._e(),e.inputVisible?t("el-input",{ref:"saveTagInput",staticClass:"input-new-tag",attrs:{size:"mini"},on:{blur:e.handleInputConfirm},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleInputConfirm.apply(null,arguments)}},model:{value:e.inputValue,callback:function(t){e.inputValue=t},expression:"inputValue"}}):t("span",{staticClass:"text-blue-400 cursor-pointer",on:{click:e.showInput}},[t("i",{staticClass:"el-icon-plus"}),t("span",{staticClass:"ml-[10px]"},[e._v("添加初始标签")])])],1)]:e._e()],2),t("div",[t("p",{staticClass:"text-black mb-[1px]"},[e._v("安装说明：")]),t("p",[e._v("1. 请用管理员权限 (root/administrator) 运行")]),t("p",[e._v("2. linux系统直接在bash终端运行安装脚本")]),t("p",[e._v(" 3. Windows系统需要先访问URL，把网页中的安装命令保存到.bat文件再运行 ")])]),t("div",{staticClass:"flex justify-end items-center"},[t("el-button",{attrs:{type:"primary",icon:"el-icon-copy-document",size:"mini"},on:{click:e.copyCommand}},[e._v("复制安装命令到剪切板")]),t("el-popconfirm",{attrs:{width:370,placement:"left","confirm-button-text":"下载可执行程序",title:"此方法下载后的agent，可以直接终端运行，但仅做临时测试使用，正式部署请使用统一的安装命令。"},on:{confirm:e.downFile}},[t("span",{staticClass:"ml-2 text-lg cursor-pointer",attrs:{slot:"reference"},slot:"reference"},[t("i",{staticClass:"el-icon-download"})])])],1)])])])},j=[];function G(e,t,s){return(t=F(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function F(e){var t=O(e,"string");return"symbol"==typeof t?t:t+""}function O(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class B{constructor(){G(this,"tags",[]),G(this,"advanced",!1),G(this,"broker",void 0),G(this,"type",1),G(this,"keepLastest",!1)}}var H={props:{},data(){return{moment:p(),agentInfo:{},form:new B,inputVisible:!1,inputValue:"",dialogShow:!1,res:null,rej:null,roomData:[],required:{required:!0,message:"请选择类别",trigger:"change"},copyvalue:""}},computed:{isVip(){const e=this.roomData.find((e=>e.id===this.form.broker));return e?.vip?.length}},methods:{openDialog(e){return this.dialogShow=!0,this.form=new B,this.agentInfo=e,this.$request.fetchGetIndices().then((e=>{this.roomData=e.data,this.form.broker=this.roomData?.[0]?.id||null})),new Promise(((e,t)=>{this.res=e,this.rej=t}))},showInput(){this.inputVisible=!0,this.$nextTick((e=>{this.$refs.saveTagInput.$refs.input.focus()}))},handleClose(e){this.form.tags=this.form.tags.filter((t=>t!==e))},handleInputConfirm(){this.inputValue&&(this.form.tags.push(this.inputValue),this.inputValue=""),this.inputVisible=!1},firstCopySuccess(){this.$message.success("内容已复制到剪切板！")},downFile(){if(this.form.broker){let e=document.createElement("a");e.href="/api/v1/deploy/minion/download?id="+this.agentInfo.id+"&broker_id="+this.form.broker,e.target="_blank",e.click()}else this.$message.error("请选择")},brokerShare(){if(this.copyvalue="",this.form.broker){const e=new URLSearchParams({broker_id:this.form.broker,goos:this.agentInfo.goos,arch:this.agentInfo.arch,version:this.agentInfo.semver,unstable:this.agentInfo.unstable,customized:this.agentInfo.customized});if(this.form.keepLastest&&e.delete("version"),this.form.tags?.length)for(let i of this.form.tags)e.append("tags",i);const t=this.roomData.find((e=>e.id===this.form.broker)),s=t.cert_id&&"0"!==t.cert_id,a=(s?"https":"http")+"://"+(3===this.form.type?t.vip?.[0]:t.lan?.[0])+"/api/v1/deploy/minion?"+e.toString();this.copyvalue="windows"!==this.agentInfo.goos?`curl "${a}" ${s?"-k":""} | /bin/bash`:a,this.$nextTick((()=>{this.$refs.copyvalueRef.click()}))}else this.$message.error("请选择通信节点")},managerShare(){if(this.copyvalue="",this.form.broker){const e=new URLSearchParams({broker_id:this.form.broker,goos:this.agentInfo.goos,arch:this.agentInfo.arch,version:this.agentInfo.semver,unstable:this.agentInfo.unstable,customized:this.agentInfo.customized});if(this.form.keepLastest&&e.delete("version"),this.form.tags?.length)for(let s of this.form.tags)e.append("tags",s);const t=window.location.protocol+"//"+window.location.host+"/api/v1/deploy/minion?"+e.toString();this.copyvalue="windows"!==this.agentInfo.goos?`curl "${t}" | /bin/bash`:t,this.$nextTick((()=>{this.$refs.copyvalueRef.click()}))}else this.$message.error("请选择通信节点")},lanManagerShare(){if(this.copyvalue="",this.form.broker){const e=this.roomData.find((e=>e.id===this.form.broker));e.lan?.length>0?this.$request.fetchGetLan().then((e=>{const t=new URLSearchParams({broker_id:this.form.broker,goos:this.agentInfo.goos,arch:this.agentInfo.arch,version:this.agentInfo.semver,unstable:this.agentInfo.unstable,customized:this.agentInfo.customized});if(this.form.keepLastest&&t.delete("version"),this.form.tags?.length)for(let a of this.form.tags)t.append("tags",a);const s=e.data.scheme+"://"+e.data.addr+"/api/v1/deploy/minion?"+t.toString();this.copyvalue="windows"!==this.agentInfo.goos?`curl "${s}" ${"https"===e.data.scheme?"-k":""} | /bin/bash`:s,this.$nextTick((()=>{this.$refs.copyvalueRef.click()}))})).catch((e=>{console.error(e),this.$message.error("复制地址出错")})):(this.copyvalue="",this.$message.error("暂无内网"))}else this.copyvalue="",this.$message.error("请选择")},copyCommand(){1===this.form.type||3===this.form.type?this.brokerShare():2===this.form.type?this.managerShare():4===this.form.type&&this.lanManagerShare()}}},Y=H,U=(0,g.A)(Y,P,j,!1,null,"0487e191",null),M=U.exports,W={components:{editAndSavaBtn:b,addNewAgent:q,share:$,installGuide:M},props:{agentType:{required:!0,type:String},goos:{required:!0,type:String},arch:{required:!0,type:String}},data(){return{versionData:[],defaultActive:"",textarea:""}},computed:{activeVersionData(){return this.versionData.find((e=>e.id===this.defaultActive))},goosIcon(){return/^\s*(mac|ios|darwin)\s*$/i.test(this.goos)?"mac":/^\s*(windows|win|window)\s*$/i.test(this.goos)?"Windows":/^\s*(linux)\s*$/i.test(this.goos)?"linux":"应用"}},created(){this.loadVerion()},methods:{async loadVerion(){try{const e=[{key:"goos",operator:"eq",value:this.goos},{key:"arch",operator:"eq",value:this.arch},{key:"customized",operator:"eq",value:"标准版"==this.agentType?"":this.agentType}].map((e=>"filters="+encodeURIComponent(JSON.stringify(e)))).join("&"),{data:t}=await h().get("/monbins?current=1&size=100&"+e);this.versionData=t.records?.filter((e=>e.goos===this.goos)).map((e=>({...e,changelogEdit:!1,featureEdit:!1,tipsEdit:!1,ctimeFormat:p()(e.created_at).format("YYYY-MM-DD HH:mm:ss")})))||[],this.defaultActive=this.versionData[0]?.id}catch(e){}},select(e){let t=this.defaultActive;this.defaultActive=e,"opt"===e&&setTimeout((()=>{this.defaultActive=t}),0)},async saveAgentInfo(){try{await h().patch("/monbin",this.activeVersionData),this.$message.success("保存成功")}catch(e){return this.$message.error(e),Promise.reject()}},async saveChangelog(){await this.saveAgentInfo(),this.activeVersionData.changelogEdit=!1},async saveFeture(){await this.saveAgentInfo(),this.activeVersionData.featureEdit=!1},async saveTips(){await this.saveAgentInfo(),this.activeVersionData.tipsEdit=!1},async subDelete(){try{const e=this.activeVersionData.id;await this.$confirm(`确定将${this.activeVersionData.customized||"标准版"}-${this.activeVersionData.goos}-${this.activeVersionData.arch}平台${this.activeVersionData.semver}版本的agent删除吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch((()=>{throw"取消操作"})),await this.$request.fetchDeleteAgent(e),this.$message({message:"删除成功!!!",type:"success"}),await this.loadVerion(),0===this.versionData.length&&this.$emit("refreshGoos")}catch(e){this.$message.error(e)}},async operaEdition(){try{const e=this.activeVersionData.id;await this.$confirm(`确定将${this.activeVersionData.goos}-${this.activeVersionData.arch}平台的agent全量推送更新至${this.activeVersionData.semver}版本？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch((()=>{throw"取消操作"})),await this.$request.fetchCheckEdtion({id:e}),this.$message({message:"推送成功!!!",type:"success"})}catch(e){this.$message.error(e)}},async deprecate(){try{const e=this.activeVersionData.id;await this.$confirm(`确定将${this.activeVersionData.customized||"标准版"}-${this.activeVersionData.goos}-${this.activeVersionData.arch}平台${this.activeVersionData.semver}版本的agent标记过期吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch((()=>{throw"取消操作"})),await this.$request.fetchDeprecate({id:e}),this.$message({message:"标记成功",type:"success"}),this.loadVerion()}catch(e){this.$message.error(e)}},addNewAgent(){this.$refs.addNewAgentRef.openDialog(this.agentType,this.goos,this.arch).then((()=>{this.loadVerion()})).catch((()=>{}))},downLoad(){(0,E.pi)("monbin?id="+this.activeVersionData.id)},textFormat(e){return e?.split("\n").filter((e=>!!e))},handleCommand(e){"download"===e?this.downLoad():"deprecate"===e?this.deprecate():"push"===e?this.operaEdition():"delete"===e&&this.subDelete()}}},J=W,K=(0,g.A)(J,n,l,!1,null,"51cda40d",null),Q=K.exports,X={props:{agentType:String,goosOptions:Array},components:{agent:Q,addNewAgent:q},data(){return{sysActive:"",sysActiveCache:"",sysTypes:[],arch:"",goos:""}},watch:{goosOptions:{handler(e){this.sysTypes=e.map((e=>({id:e.goos+"-"+e.arch,...e}))),e?.length&&this.select(this.sysTypes?.[0]?.id)},immediate:!0}},created(){},methods:{async loadAgentDetail(){},select(e){const t=this.sysActive;if(this.sysActive=e,"add"===e)setTimeout((()=>{this.sysActive=t}),0);else if(t!==e){this.sysActiveCache=e;const t=this.sysTypes.find((t=>t.id===e));this.goos=t.goos,this.arch=t.arch}},addNew(){this.$refs.addNewAgentRef.openDialog(this.agentType).then((()=>{this.$emit("refresTab")}))}}},Z=X,ee=(0,g.A)(Z,o,r,!1,null,"42f758ba",null),te=ee.exports,se=function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{"el-dialog":"",visible:e.show,title:"新增类型","append-to-body":"",width:"300px","destroy-on-close":""},on:{"update:visible":function(t){e.show=t},close:e.onClose}},[t("el-form",{ref:"formRef",attrs:{model:e.form,size:"small","label-position":"top"}},[t("el-form-item",{attrs:{label:"名称:",prop:"name",rules:e.required}},[t("el-input",{attrs:{placeholder:"请输入类型名称"},model:{value:e.form.name,callback:function(t){e.$set(e.form,"name",t)},expression:"form.name"}})],1),t("el-form-item",{attrs:{label:"图标:",prop:"icon",rules:e.required}},[t("el-popover",{attrs:{placement:"bottom-start",width:"460",trigger:"click"},on:{show:function(t){return e.$refs["iconSelect"].reset()}}},[t("IconSelect",{ref:"iconSelect",on:{selected:t=>e.form.icon=t}}),t("el-input",{attrs:{slot:"reference",placeholder:"点击选择图标",readonly:""},slot:"reference",model:{value:e.form.icon,callback:function(t){e.$set(e.form,"icon",t)},expression:"form.icon"}},[e.form.icon?t("svg-icon",{staticClass:"el-input__icon",staticStyle:{height:"16px",width:"16px"},attrs:{slot:"prefix","icon-class":e.form.icon},slot:"prefix"}):t("i",{staticClass:"el-icon-search el-input__icon",attrs:{slot:"prefix"},slot:"prefix"})],1)],1)],1)],1),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{attrs:{size:"small"},on:{click:function(t){e.show=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(t){return e.onSubmit("form")}}},[e._v("提交")])],1)],1)},ae=[],ie=s(74804);function oe(e,t,s){return(t=re(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function re(e){var t=ne(e,"string");return"symbol"==typeof t?t:t+""}function ne(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class le{constructor(){oe(this,"name",""),oe(this,"icon","")}}var ce={components:{IconSelect:ie.A},data(){return{form:new le,show:!1,required:{required:!0,message:"请填写必填选项",trigger:"change"},res:null,rej:null}},computed:{},methods:{openDialog(e,t,s){return this.$nextTick((()=>{this.$refs.form?.resetFields()})),this.form=new le,this.show=!0,new Promise(((e,t)=>{this.res=e,this.rej=t}))},async onSubmit(){try{await this.$refs.formRef.validate().catch((()=>{throw"请输入必填项"}));const e=this.form;await V.A.post("/monbin/customized",e),this.show=!1,this.$message.success("保存成功"),this.res()}catch(e){this.$message.error(e)}},onClose(){this.rej?.()}}},he=ce,de=(0,g.A)(he,se,ae,!1,null,"44d8393e",null),pe=de.exports,me={components:{platform:te,addNewTab:pe},data(){return{activeName:"",tabs:[],goosOptions:[]}},created(){this.loadTabs()},methods:{async loadTabs(){try{const{data:e}=await h().get("/monbin/customizes"),t=(await h().get("/monbin/classify"))?.data?.reduce(((e,t)=>(e[t.customized||"标准版"]=t.structures,e)),{});this.tabs=[{name:"标准版",value:"标准版"},...e].map(((e,s)=>({id:e.id,label:e.name,value:e.name,icon:e.icon||"通用",children:t[e.name]||[]}))),this.activeName=this.activeName||this.tabs[0].value;const s=this.tabs.find((e=>e.value===this.activeName));this.goosOptions=s.children||[]}catch(e){}},addNew(){this.$refs.addNewTabRef.openDialog().then((()=>{this.loadTabs()})).catch((()=>{}))},beforeTabLeave(e,t){if("add"===e)return this.addNew(),!1;const s=this.tabs.find((t=>t.value===e));return this.goosOptions=s.children,!0},async deleteTag(e){try{await h()["delete"]("/monbin/customized",{data:{id:e}}),this.$message.success("删除成功"),this.loadTabs()}catch(t){this.$message.error(t)}}}},ue=me,fe=(0,g.A)(ue,a,i,!1,null,"0f3e370c",null),ve=fe.exports}}]);